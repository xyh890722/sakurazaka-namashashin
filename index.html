<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sakurazaka46 Photo Tracker</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sakura: {
                            DEFAULT: '#f4aebb', // æ«»å‚ç²‰
                            dark: '#d68a9f',
                        },
                        darkgray: '#333333'
                    }
                }
            }
        }
    </script>

    <style>
        /* éš±è— Scrollbar ä½†ä¿ç•™åŠŸèƒ½ (Webkit) */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-gray-50 text-darkgray font-sans pb-20">

    <div id="app" v-cloak>
        <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-md shadow-sm border-b border-pink-100">
            <div class="px-4 py-3 flex space-x-2 overflow-x-auto hide-scrollbar items-center">
                <button 
                    @click="currentFilter = 'Total'"
                    :class="currentFilter === 'Total' ? 'bg-sakura text-white shadow-md' : 'bg-gray-100 text-gray-500'"
                    class="whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-bold transition-all flex-shrink-0">
                    Total
                </button>
                
                <button 
                    v-for="member in uniqueMembers" 
                    :key="member"
                    @click="currentFilter = member"
                    :class="currentFilter === member ? 'bg-sakura text-white shadow-md' : 'bg-gray-100 text-gray-500'"
                    class="whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-medium transition-all flex-shrink-0">
                    {{ member }}
                </button>
            </div>
        </header>

        <main class="p-4 max-w-md mx-auto">
            
            <div v-if="loading" class="text-center py-10 text-sakura">
                <p class="animate-pulse font-bold">è®€å–è³‡æ–™ä¸­...</p>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-4 mb-6 border border-gray-100">
                <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">New Entry</h2>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="text-xs text-gray-500 block mb-1">æˆå“¡</label>
                            <div class="relative">
                                <select v-model="newItem.member" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-sm appearance-none focus:outline-none focus:border-sakura">
                                    <option disabled value="">é¸æ“‡æˆå“¡</option>
                                    <option v-for="m in presetMembers" :value="m">{{ m }}</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 block mb-1">å¥—çµ„åç¨±</label>
                            <input v-model="newItem.set_name" type="text" placeholder="ex: 2025æŒ¯è¢–" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-sm focus:outline-none focus:border-sakura">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 block mb-1">æ§‹æˆ (ä»¥é€—è™Ÿåˆ†éš”)</label>
                        <input v-model="newItem.poses_input" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-sm focus:outline-none focus:border-sakura">
                    </div>
                    
                    <button @click="addNewItem" :disabled="submitting" class="w-full bg-darkgray hover:bg-black text-white py-2 rounded-lg text-sm font-bold transition-colors disabled:opacity-50">
                        {{ submitting ? 'è™•ç†ä¸­...' : 'ï¼‹ æ–°å¢ç”Ÿå¯«çœŸ' }}
                    </button>
                </div>
            </div>

            <div class="space-y-4">
                <div v-if="filteredItems.length === 0 && !loading" class="text-center text-gray-400 text-sm py-8">
                    æ²’æœ‰ç¬¦åˆçš„è³‡æ–™
                </div>

                <div v-for="item in filteredItems" :key="item.id" class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 relative overflow-hidden transition-all duration-300">
                    
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="text-xs text-sakura font-bold mb-0.5">{{ item.member }}</div>
                            <div class="text-lg font-bold text-gray-800 leading-tight">{{ item.set_name }}</div>
                        </div>
                        <div v-if="isComp(item.poses_json)" class="bg-yellow-400 text-yellow-900 text-xs font-black px-2 py-1 rounded shadow-sm transform rotate-3 flex items-center">
                            <span>ğŸ‘‘ COMP</span>
                        </div>
                    </div>

                    <hr class="border-gray-100 mb-3">

                    <div class="grid grid-cols-4 gap-2">
                        <button 
                            v-for="(pose, idx) in item.poses_json" 
                            :key="idx"
                            @click="cyclePoseState(item, idx)"
                            class="flex flex-col items-center justify-center py-2 rounded-lg transition-colors duration-200 border"
                            :class="getButtonClass(pose.s)">
                            
                            <span class="text-xs font-bold">{{ pose.n }}</span> <span class="text-[10px] opacity-80">{{ getStatusLabel(pose.s) }}</span> </button>
                    </div>

                    <div v-if="item._saving" class="absolute bottom-1 right-2 text-[10px] text-gray-300">
                        Saving...
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // å¡«å…¥æ‚¨éƒ¨ç½²çš„ GAS Web App URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbwreffKPHBOSNXJiwNZl_5OCuBtxtmVqIagxi_CRmPfNgFcWRYarr5ZhcjuxrYPSVSm-g/exec';

        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const items = ref([]);
                const loading = ref(false);
                const submitting = ref(false);
                const currentFilter = ref('Total');
                
                // é è¨­æˆå“¡åå–®
                const presetMembers = [
                   'ç”°æ‘ä¿ä¹ƒ', 'æ£®ç”°ã²ã‹ã‚‹', 'å±±ï¨‘å¤©', 'è—¤å‰å¤éˆ´', 'å®ˆå±‹éº—å¥ˆ', 
                   'å¤§åœ’ç²', 'å±±ä¸‹ç³æœˆ', 'è°·å£æ„›å­£', 'æ‘äº•å„ª', 'ä¸­å¶‹å„ªæœˆ'
                ];

                // æ–°å¢è¡¨å–®è³‡æ–™
                const newItem = ref({
                    member: '',
                    set_name: '',
                    poses_input: 'ãƒ¨ãƒª, ãƒãƒ¥ã‚¦, ãƒ’ã‚­, åº§ã‚Š'
                });

                // Debounce timer map
                const debounceTimers = {};

                // 1. Fetch Data
                const fetchData = async () => {
                    loading.value = true;
                    try {
                        const res = await fetch(API_URL);
                        const json = await res.json();
                        if(json.status === 'success'){
                            items.value = json.data;
                        }
                    } catch (e) {
                        alert('è®€å–å¤±æ•—: ' + e);
                    } finally {
                        loading.value = false;
                    }
                };

                // 2. Computed: Filter Logic
                const uniqueMembers = computed(() => {
                    const members = items.value.map(i => i.member);
                    return [...new Set(members)].sort();
                });

                const filteredItems = computed(() => {
                    if (currentFilter.value === 'Total') return items.value;
                    return items.value.filter(i => i.member === currentFilter.value);
                });

                // 3. Add Item
                const addNewItem = async () => {
                    if(!newItem.value.member || !newItem.value.set_name) return alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
                    
                    submitting.value = true;
                    
                    // è§£æå§¿å‹¢å­—ä¸²ç‚º JSON çµæ§‹: [{n: 'ãƒ¨ãƒª', s: 0}, ...]
                    // s (status): 0=None, 1=Owned, 2=Trade, 3=Spare
                    const posesArray = newItem.value.poses_input.split(/[,ï¼Œ]/).map(p => ({
                        n: p.trim(),
                        s: 0 
                    })).filter(p => p.n);

                    const payload = {
                        id: Date.now(), // Timestamp ID
                        member: newItem.value.member,
                        set_name: newItem.value.set_name,
                        poses_json: posesArray
                    };

                    // Optimistic UI Update (å…ˆåŠ åˆ°ç•«é¢)
                    items.value.unshift(payload);

                    // Call API
                    try {
                        await fetch(API_URL, {
                            method: 'POST',
                            mode: 'no-cors', // é‡è¦ï¼šGAS post å¸¸ç”¨ hack
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: 'upsert', data: payload })
                        });
                        // Reset Form
                        newItem.value.set_name = '';
                    } catch(e) {
                        alert('æ–°å¢å¤±æ•—ï¼Œè«‹é‡æ•´é é¢');
                    } finally {
                        submitting.value = false;
                    }
                };

                // 4. Interaction: Cycle Status
                const cyclePoseState = (item, poseIndex) => {
                    // ç‹€æ…‹å¾ªç’°: 0 -> 1 -> 2 -> 3 -> 0
                    let currentStatus = item.poses_json[poseIndex].s;
                    item.poses_json[poseIndex].s = (currentStatus + 1) % 4;

                    // Trigger Debounced Save
                    saveItemDebounced(item);
                };

                const saveItemDebounced = (item) => {
                    item._saving = true; // UI Hint
                    
                    // Clear existing timer for this item
                    if (debounceTimers[item.id]) clearTimeout(debounceTimers[item.id]);

                    // Set new timer (1.5ç§’å¾Œå„²å­˜)
                    debounceTimers[item.id] = setTimeout(async () => {
                        try {
                            await fetch(API_URL, {
                                method: 'POST',
                                mode: 'no-cors',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ action: 'upsert', data: item })
                            });
                        } catch(e) {
                            console.error('Auto save failed', e);
                        } finally {
                            item._saving = false;
                            delete debounceTimers[item.id];
                        }
                    }, 1500);
                };

                // Helpers
                const getButtonClass = (status) => {
                    switch(status) {
                        case 1: return 'bg-sakura text-white border-sakura shadow-md'; // æ”¶è—ä¸­
                        case 2: return 'bg-yellow-400 text-yellow-900 border-yellow-400'; // äº¤æ›ä¸­
                        case 3: return 'bg-blue-400 text-white border-blue-400'; // è¤‡æ•¸
                        default: return 'bg-gray-50 text-gray-400 border-gray-200'; // ç„¡
                    }
                };

                const getStatusLabel = (status) => {
                    switch(status) {
                        case 1: return 'GET';
                        case 2: return 'TRADE';
                        case 3: return 'SPARE';
                        default: return 'NONE';
                    }
                };

                const isComp = (poses) => {
                    if (!poses || poses.length === 0) return false;
                    // æª¢æŸ¥æ˜¯å¦æ¯ä¸€å€‹ pose çš„ status éƒ½æ˜¯ 1
                    return poses.every(p => p.s === 1);
                };

                onMounted(() => {
                    fetchData();
                });

                return {
                    items, loading, submitting, presetMembers, newItem, currentFilter,
                    uniqueMembers, filteredItems,
                    addNewItem, cyclePoseState, getButtonClass, getStatusLabel, isComp
                };
            }
        }).mount('#app');
    </script>
</body>
</html>