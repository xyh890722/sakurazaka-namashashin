<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sakurazaka46 Photo Tracker</title>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sakura: {
                            DEFAULT: '#f4aebb', // æ«»å‚ç²‰
                            dark: '#d68a9f',
                        },
                        darkgray: '#333333'
                    }
                }
            }
        }
    </script>

    <style>
        /* éš±è— Scrollbar ä½†ä¿ç•™åŠŸèƒ½ (Webkit) */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        [v-cloak] {
            display: none;
        }
    </style>
</head>

<body class="bg-gray-50 text-darkgray font-sans pb-20">

    <div id="app" v-cloak>
        <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-md shadow-sm border-b border-pink-100">
            <div class="px-4 py-3 flex space-x-2 overflow-x-auto hide-scrollbar items-center">
                <button @click="currentFilter = 'Total'"
                    :class="currentFilter === 'Total' ? 'bg-sakura text-white shadow-md' : 'bg-gray-100 text-gray-500'"
                    class="whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-bold transition-all flex-shrink-0">
                    Total
                </button>

                <button v-for="member in uniqueMembers" :key="member" @click="currentFilter = member"
                    :class="currentFilter === member ? 'bg-sakura text-white shadow-md' : 'bg-gray-100 text-gray-500'"
                    class="whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-medium transition-all flex-shrink-0">
                    {{ member }}
                </button>
            </div>
        </header>

        <main class="p-4 max-w-md mx-auto">

            <div v-if="loading" class="text-center py-10 text-sakura">
                <p class="animate-pulse font-bold">è®€å–è³‡æ–™ä¸­...</p>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-4 mb-6 border border-gray-100">
                <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">New Entry</h2>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-xs text-gray-500 block mb-1">æœŸåˆ¥</label>
                                <div class="relative">
                                    <select v-model="selectedGen" @change="handleGenChange"
                                        class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-sm appearance-none focus:outline-none focus:border-sakura">
                                        <option disabled value="">é¸æ“‡æœŸåˆ¥</option>
                                        <option v-for="(list, gen) in memberData" :key="gen" :value="gen">{{ gen }}
                                        </option>
                                    </select>
                                    <div
                                        class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 20 20">
                                            <path
                                                d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="text-xs text-gray-500 block mb-1">æˆå“¡</label>
                                <div class="relative">
                                    <select v-model="newItem.member" :disabled="!selectedGen"
                                        class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-sm appearance-none focus:outline-none focus:border-sakura disabled:bg-gray-100 disabled:text-gray-400">
                                        <option disabled value="">
                                            {{ selectedGen ? 'é¸æ“‡æˆå“¡' : 'é¸æ“‡æˆå“¡' }}
                                        </option>
                                        <option v-for="m in currentMemberOptions" :value="m">{{ m }}</option>
                                    </select>
                                    <div
                                        class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 20 20">
                                            <path
                                                d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 block mb-1">å¥—çµ„åç¨±</label>
                            <input v-model="newItem.set_name" type="text" placeholder="ex: 2025æŒ¯è¢–"
                                class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-sm focus:outline-none focus:border-sakura">
                        </div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 block mb-1">æ§‹æˆ (ä»¥é€—è™Ÿåˆ†éš”)</label>
                        <input v-model="newItem.poses_input" type="text"
                            class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-sm focus:outline-none focus:border-sakura">
                    </div>

                    <button @click="addNewItem" :disabled="submitting"
                        class="w-full bg-darkgray hover:bg-black text-white py-2 rounded-lg text-sm font-bold transition-colors disabled:opacity-50">
                        {{ submitting ? 'è™•ç†ä¸­...' : 'ï¼‹ æ–°å¢ç”Ÿå¯«çœŸ' }}
                    </button>
                </div>
            </div>

            <div class="space-y-4">
                <div v-if="filteredItems.length === 0 && !loading" class="text-center text-gray-400 text-sm py-8">
                    æ²’æœ‰ç¬¦åˆçš„è³‡æ–™
                </div>

                <div v-for="item in filteredItems" :key="item.id"
                    class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 relative overflow-hidden transition-all duration-300">

                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="text-xs text-sakura font-bold mb-0.5">{{ item.member }}</div>
                            <div class="text-lg font-bold text-gray-800 leading-tight">{{ item.set_name }}</div>
                        </div>

                        <div class="flex items-center space-x-2">
                            <div v-if="isComp(item.poses_json)"
                                class="bg-yellow-400 text-yellow-900 text-xs font-black px-2 py-1 rounded shadow-sm transform rotate-3 flex items-center">
                                <span>ğŸ‘‘ COMP</span>
                            </div>

                            <button @click="deleteItem(item)" class="text-gray-300 hover:text-red-400 p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <hr class="border-gray-100 mb-3">

                    <div class="grid grid-cols-4 gap-2">
                        <button v-for="(pose, idx) in item.poses_json" :key="idx" @click="cyclePoseState(item, idx)"
                            class="flex flex-col items-center justify-center py-2 rounded-lg transition-colors duration-200 border"
                            :class="getButtonClass(pose.s)">

                            <span class="text-xs font-bold">{{ pose.n }}</span> <span class="text-[10px] opacity-80">{{
                                getStatusLabel(pose.s) }}</span> </button>
                    </div>

                    <div v-if="item._saving" class="absolute bottom-1 right-2 text-[10px] text-gray-300">
                        Saving...
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // å¡«å…¥æ‚¨éƒ¨ç½²çš„ GAS Web App URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbwreffKPHBOSNXJiwNZl_5OCuBtxtmVqIagxi_CRmPfNgFcWRYarr5ZhcjuxrYPSVSm-g/exec';

        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const items = ref([]);
                const loading = ref(false);
                const submitting = ref(false);
                const currentFilter = ref('Total');

                const selectedGen = ref(''); // å„²å­˜ç›®å‰é¸æ“‡çš„æœŸåˆ¥ (äºŒæœŸ/ä¸‰æœŸ/å››æœŸ)

                // å®šç¾©å®Œæ•´çš„æˆå“¡è³‡æ–™çµæ§‹
                const memberData = {
                    'äºŒæœŸç”Ÿ': [
                        'äº•ä¸Š æ¢¨å', 'é è—¤ å…‰è‰', 'å¤§åœ’ ç²', 'å¤§æ²¼ æ™¶ä¿', 'å¹¸é˜ª èŒ‰é‡Œä¹ƒ',
                        'æ­¦å…ƒ å”¯è¡£', 'ç”°æ‘ ä¿ä¹ƒ', 'è—¤å‰ å¤éˆ´', 'å¢—æœ¬ ç¶ºè‰¯', 'æ¾ç”° é‡Œå¥ˆ',
                        'æ£®ç”° ã²ã‹ã‚‹', 'å®ˆå±‹ éº—å¥ˆ', 'å±±ï¨‘ å¤©'
                    ],
                    'ä¸‰æœŸç”Ÿ': [
                        'çŸ³æ£® ç’ƒèŠ±', 'é è—¤ ç†å­', 'å°ç”°å€‰ éº—å¥ˆ', 'å°å³¶ å‡ªç´—', 'è°·å£ æ„›å­£',
                        'ä¸­å¶‹ å„ªæœˆ', 'çš„é‡ ç¾é’', 'å‘äº• ç´”è‘‰', 'æ‘äº• å„ª', 'æ‘å±± ç¾ç¾½', 'å±±ä¸‹ ç³æœˆ'
                    ],
                    'å››æœŸç”Ÿ': [
                        'æµ…äº• æ‹ä¹ƒæœª', 'ç¨²ç†Š ã²ãª', 'å‹åˆ æ˜¥', 'ä½è—¤ æ„›æ¡œ', 'ä¸­å· æ™ºå°‹',
                        'æ¾æœ¬ å’Œå­', 'ç›®é»’ é™½è‰²', 'å±±å· å®‡è¡£', 'å±±ç”° æ¡ƒå®Ÿ'
                    ]
                };

                // è¨ˆç®—å±¬æ€§ï¼šæ ¹æ“šé¸åˆ°çš„æœŸåˆ¥ï¼Œå›å‚³è©²æœŸçš„æˆå“¡åå–®
                const currentMemberOptions = computed(() => {
                    if (!selectedGen.value) return [];
                    return memberData[selectedGen.value];
                });

                // ç•¶æœŸåˆ¥æ”¹è®Šæ™‚ï¼Œé‡ç½®å·²é¸çš„æˆå“¡ (é¿å…é¸äº†äºŒæœŸå»é‚„ç•™è‘—ä¸‰æœŸæˆå“¡çš„åå­—)
                const handleGenChange = () => {
                    newItem.value.member = '';
                };

                // æ–°å¢è¡¨å–®è³‡æ–™
                const newItem = ref({
                    member: '',
                    set_name: '',
                    poses_input: 'ãƒ¨ãƒª, ãƒãƒ¥ã‚¦, ãƒ’ã‚­, åº§ã‚Š'
                });

                // Debounce timer map
                const debounceTimers = {};

                // 1. Fetch Data
                const fetchData = async () => {
                    loading.value = true;
                    try {
                        const res = await fetch(API_URL);
                        const json = await res.json();
                        if (json.status === 'success') {
                            items.value = json.data;
                        }
                    } catch (e) {
                        alert('è®€å–å¤±æ•—: ' + e);
                    } finally {
                        loading.value = false;
                    }
                };

                // 2. Computed: Filter Logic
                const uniqueMembers = computed(() => {
                    const members = items.value.map(i => i.member);
                    return [...new Set(members)].sort();
                });

                const filteredItems = computed(() => {
                    if (currentFilter.value === 'Total') return items.value;
                    return items.value.filter(i => i.member === currentFilter.value);
                });

                // 3. Add Item
                const addNewItem = async () => {
                    if (!newItem.value.member || !newItem.value.set_name) return alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');

                    submitting.value = true;

                    // è§£æå§¿å‹¢å­—ä¸²ç‚º JSON çµæ§‹: [{n: 'ãƒ¨ãƒª', s: 0}, ...]
                    // s (status): 0=None, 1=Owned, 2=Trade, 3=Spare
                    const posesArray = newItem.value.poses_input.split(/[,ï¼Œ]/).map(p => ({
                        n: p.trim(),
                        s: 0
                    })).filter(p => p.n);

                    const payload = {
                        id: Date.now(), // Timestamp ID
                        member: newItem.value.member,
                        set_name: newItem.value.set_name,
                        poses_json: posesArray
                    };

                    // Optimistic UI Update (å…ˆåŠ åˆ°ç•«é¢)
                    items.value.unshift(payload);

                    // Call API
                    try {
                        await fetch(API_URL, {
                            method: 'POST',
                            mode: 'no-cors', // é‡è¦ï¼šGAS post å¸¸ç”¨ hack
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: 'upsert', data: payload })
                        });
                        // Reset Form
                        newItem.value.set_name = '';
                    } catch (e) {
                        alert('æ–°å¢å¤±æ•—ï¼Œè«‹é‡æ•´é é¢');
                    } finally {
                        submitting.value = false;
                    }
                };

                // 4. Interaction: Cycle Status
                const cyclePoseState = (item, poseIndex) => {
                    // ç‹€æ…‹å¾ªç’°: 0 -> 1 -> 2 -> 3 -> 0
                    let currentStatus = item.poses_json[poseIndex].s;
                    item.poses_json[poseIndex].s = (currentStatus + 1) % 4;

                    // Trigger Debounced Save
                    saveItemDebounced(item);
                };

                const saveItemDebounced = (item) => {
                    item._saving = true; // UI Hint

                    // Clear existing timer for this item
                    if (debounceTimers[item.id]) clearTimeout(debounceTimers[item.id]);

                    // Set new timer (1.5ç§’å¾Œå„²å­˜)
                    debounceTimers[item.id] = setTimeout(async () => {
                        try {
                            await fetch(API_URL, {
                                method: 'POST',
                                mode: 'no-cors',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ action: 'upsert', data: item })
                            });
                        } catch (e) {
                            console.error('Auto save failed', e);
                        } finally {
                            item._saving = false;
                            delete debounceTimers[item.id];
                        }
                    }, 1500);
                };
                // åˆªé™¤åŠŸèƒ½
                const deleteItem = async (item) => {
                    // 1. é˜²å‘†ç¢ºèª
                    if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${item.member} ${item.set_name}ã€å—ï¼Ÿ\nåˆªé™¤å¾Œç„¡æ³•å¾©åŸå–”ï¼`)) return;

                    // 2. æ¨‚è§€æ›´æ–° UI (å…ˆå¾ç•«é¢ç§»é™¤ï¼Œæ„Ÿè¦ºæ¯”è¼ƒå¿«)
                    // ä½¿ç”¨ filter æŠŠé€™å€‹ ID éæ¿¾æ‰
                    items.value = items.value.filter(i => i.id !== item.id);

                    // 3. å‘¼å«å¾Œç«¯ API
                    try {
                        await fetch(API_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                action: 'delete',
                                data: { id: item.id }
                            })
                        });
                        console.log('åˆªé™¤æŒ‡ä»¤å·²ç™¼é€');
                    } catch (e) {
                        alert('åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯');
                        // å¦‚æœå¤±æ•—ï¼Œç†è«–ä¸Šè¦é‡æ–°è®€å–è³‡æ–™æŠŠå¡ç‰‡åŠ å›ä¾†ï¼Œé€™è£¡å¾ç°¡
                        fetchData();
                    }
                };

                // Helpers
                const getButtonClass = (status) => {
                    switch (status) {
                        case 1: return 'bg-sakura text-white border-sakura shadow-md'; // æ”¶è—ä¸­
                        case 2: return 'bg-yellow-400 text-yellow-900 border-yellow-400'; // äº¤æ›ä¸­
                        case 3: return 'bg-blue-400 text-white border-blue-400'; // è¤‡æ•¸
                        default: return 'bg-gray-50 text-gray-400 border-gray-200'; // ç„¡
                    }
                };

                const getStatusLabel = (status) => {
                    switch (status) {
                        case 1: return 'GET';
                        case 2: return 'TRADE';
                        case 3: return 'SPARE';
                        default: return 'NONE';
                    }
                };

                const isComp = (poses) => {
                    if (!poses || poses.length === 0) return false;
                    // æª¢æŸ¥æ˜¯å¦æ¯ä¸€å€‹ pose çš„ status éƒ½æ˜¯ 1
                    return poses.every(p => p.s === 1);
                };

                onMounted(() => {
                    fetchData();
                });

                return {
                    items, loading, submitting, newItem, currentFilter,
                    uniqueMembers, filteredItems,
                    addNewItem, cyclePoseState, getButtonClass, getStatusLabel, isComp, deleteItem,
                    memberData, selectedGen, currentMemberOptions, handleGenChange
                };
            }
        }).mount('#app');
    </script>
</body>


</html>
