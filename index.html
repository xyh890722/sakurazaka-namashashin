<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sakurazaka46 Photo Tracker</title>
    <link rel="icon" href="photo/icon.jpg" type="image/jpeg">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sakura: {
                            DEFAULT: '#f4aebb', // æ«»å‚ç²‰
                            dark: '#d68a9f',
                        },
                        darkgray: '#333333'
                    }
                }
            }
        }
    </script>

    <style>
        /* éš±è— Scrollbar ä½†ä¿ç•™åŠŸèƒ½ (Webkit) */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        [v-cloak] {
            display: none;
        }
    </style>
</head>

<body class="bg-gray-50 text-darkgray font-sans pb-20">

    <div id="app" v-cloak>
        <header class="sticky top-0 z-50 bg-white/95 backdrop-blur-md shadow-sm border-b border-pink-100 pb-2">

            <div class="px-4 pt-3 pb-2">
                <div class="relative">
                    <input v-model="searchQuery" type="text" placeholder="ğŸ” æœå°‹å¥—çµ„åç¨± (ex: æŒ¯è¢–)"
                        class="w-full bg-gray-100 text-gray-700 text-sm rounded-lg pl-3 pr-3 py-2 focus:outline-none focus:ring-2 focus:ring-sakura transition-all">
                    <button v-if="searchQuery" @click="searchQuery = ''"
                        class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs bg-gray-200 rounded-full w-5 h-5 flex items-center justify-center">
                        âœ•
                    </button>
                </div>
            </div>

            <div class="px-4 pb-2 flex space-x-2 overflow-x-auto hide-scrollbar items-center">
                <button @click="currentFilter = 'Total'"
                    :class="currentFilter === 'Total' ? 'bg-sakura text-white shadow-md' : 'bg-gray-100 text-gray-500'"
                    class="whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-bold transition-all flex-shrink-0">
                    Total
                </button>
                <button v-for="member in uniqueMembers" :key="member" @click="currentFilter = member"
                    :class="currentFilter === member ? 'bg-sakura text-white shadow-md' : 'bg-gray-100 text-gray-500'"
                    class="whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-medium transition-all flex-shrink-0">
                    {{ member }}
                </button>
            </div>
        </header>

        <main class="p-4 max-w-md mx-auto">

            <div v-if="loading" class="text-center py-10 text-sakura">
                <p class="animate-pulse font-bold">è®€å–è³‡æ–™ä¸­...</p>
            </div>

            <div class="bg-white rounded-xl shadow-sm mb-6 border border-gray-100 overflow-hidden transition-all">

                <div @click="showInputForm = !showInputForm"
                    class="p-4 flex justify-between items-center cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors select-none">

                    <div class="flex items-center space-x-2">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">New Entry</span>
                        <span v-if="showInputForm" class="w-2 h-2 rounded-full bg-green-400"></span>
                    </div>

                    <div class="text-gray-400 transition-transform duration-300"
                        :class="showInputForm ? 'rotate-45' : ''">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                    </div>
                </div>

                <div v-show="showInputForm" class="px-4 pb-4 bg-white border-t border-gray-100">
                    <div class="space-y-3 pt-3">
                        <div class="grid grid-cols-3 gap-2">
                            <div class="col-span-1">
                                <label class="text-xs text-gray-500 block mb-1">æˆå“¡</label>
                                <div class="relative">
                                    <select v-model="newItem.member"
                                        class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-sm appearance-none focus:outline-none focus:border-sakura">
                                        <option disabled value="">é¸æ“‡</option>
                                        <option v-for="m in allMembers" :value="m">{{ m }}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-span-2">
                                <label class="text-xs text-gray-500 block mb-1">å¥—çµ„åç¨±</label>
                                <input v-model="newItem.set_name" type="text" placeholder="ex: 2025æŒ¯è¢–"
                                    class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-sm focus:outline-none focus:border-sakura">
                            </div>
                        </div>

                        <div>
                            <label class="text-xs text-gray-500 block mb-1">æ§‹æˆ (ä»¥é€—è™Ÿåˆ†éš”)</label>
                            <input v-model="newItem.poses_input" type="text"
                                class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-sm focus:outline-none focus:border-sakura">
                        </div>

                        <button @click="addNewItem" :disabled="submitting"
                            class="w-full bg-darkgray hover:bg-black text-white py-2 rounded-lg text-sm font-bold transition-colors disabled:opacity-50">
                            {{ submitting ? 'è™•ç†ä¸­...' : 'ï¼‹ æ–°å¢ç”Ÿå¯«çœŸ' }}
                        </button>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <div v-if="filteredItems.length === 0 && !loading" class="text-center text-gray-400 text-sm py-8">
                    æ²’æœ‰ç¬¦åˆçš„è³‡æ–™
                </div>

                <div v-for="item in filteredItems" :key="item.id"
                    class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 relative overflow-hidden transition-all duration-300">

                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="text-xs text-sakura font-bold mb-0.5">{{ item.member }}</div>
                            <div class="text-lg font-bold text-gray-800 leading-tight">{{ item.set_name }}</div>
                        </div>

                        <div class="flex items-center space-x-2">
                            <div v-if="isComp(item.poses_json)"
                                class="bg-yellow-400 text-yellow-900 text-xs font-black px-2 py-1 rounded shadow-sm transform rotate-3 flex items-center">
                                <span>ğŸ‘‘ COMP</span>
                            </div>

                            <button @click="deleteItem(item)" class="text-gray-300 hover:text-red-400 p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <hr class="border-gray-100 mb-3">

                    <div class="grid grid-cols-4 gap-2">
                        <button v-for="(pose, idx) in item.poses_json" :key="idx" @click="cyclePoseState(item, idx)"
                            class="flex flex-col items-center justify-center py-2 rounded-lg transition-colors duration-200 border"
                            :class="getButtonClass(pose.s)">

                            <span class="text-xs font-bold">{{ pose.n }}</span> <span class="text-[10px] opacity-80">{{
                                getStatusLabel(pose.s) }}</span> </button>
                    </div>

                    <div v-if="item._saving" class="absolute bottom-1 right-2 text-[10px] text-gray-300">
                        Saving...
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // å¡«å…¥æ‚¨éƒ¨ç½²çš„ GAS Web App URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbwreffKPHBOSNXJiwNZl_5OCuBtxtmVqIagxi_CRmPfNgFcWRYarr5ZhcjuxrYPSVSm-g/exec';

        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const items = ref([]);
                const loading = ref(false);
                const submitting = ref(false);

                // 1. å®šç¾©æˆå“¡åå–® (ç›´æ¥åˆ—å‡ºæ‰€æœ‰æˆå“¡ï¼Œä¸åˆ†å±¤)
                const allMembers = [
                    'æ«»å‚46',
                    'äº•ä¸Š æ¢¨å', 'é è—¤ å…‰è‰', 'å¤§åœ’ ç²', 'å¤§æ²¼ æ™¶ä¿', 'å¹¸é˜ª èŒ‰é‡Œä¹ƒ',
                    'æ­¦å…ƒ å”¯è¡£', 'ç”°æ‘ ä¿ä¹ƒ', 'è—¤å‰ å¤éˆ´', 'å¢—æœ¬ ç¶ºè‰¯', 'æ¾ç”° é‡Œå¥ˆ',
                    'æ£®ç”° ã²ã‹ã‚‹', 'å®ˆå±‹ éº—å¥ˆ', 'å±±ï¨‘ å¤©',
                    'çŸ³æ£® ç’ƒèŠ±', 'é è—¤ ç†å­', 'å°ç”°å€‰ éº—å¥ˆ', 'å°å³¶ å‡ªç´—', 'è°·å£ æ„›å­£',
                    'ä¸­å¶‹ å„ªæœˆ', 'çš„é‡ ç¾é’', 'å‘äº• ç´”è‘‰', 'æ‘äº• å„ª', 'æ‘å±± ç¾ç¾½', 'å±±ä¸‹ ç³æœˆ',
                    'æµ…äº• æ‹ä¹ƒæœª', 'ç¨²ç†Š ã²ãª', 'å‹åˆ æ˜¥', 'ä½è—¤ æ„›æ¡œ', 'ä¸­å· æ™ºå°‹',
                    'æ¾æœ¬ å’Œå­', 'ç›®é»’ é™½è‰²', 'å±±å· å®‡è¡£', 'å±±ç”° æ¡ƒå®Ÿ'
                ];

                // 2. æ–°å¢çš„ç‹€æ…‹è®Šæ•¸
                const currentFilter = ref('Total');
                const searchQuery = ref('');        // æœå°‹ç”¨
                const showInputForm = ref(false);   // æ”¶æŠ˜é¸å–®ç”¨

                const newItem = ref({
                    member: '',
                    set_name: '',
                    poses_input: 'ãƒ¨ãƒª, ãƒãƒ¥ã‚¦, ãƒ’ã‚­, åº§ã‚Š'
                });

                const debounceTimers = {};

                // Fetch Data (å« LocalStorage å¿«å–å„ªåŒ–)
                const fetchData = async () => {
                    const cachedData = localStorage.getItem('sakura_tracker_data');
                    if (cachedData) {
                        try { items.value = JSON.parse(cachedData); } catch (e) { }
                    }
                    if (items.value.length === 0) loading.value = true;

                    try {
                        const res = await fetch(API_URL);
                        const json = await res.json();
                        if (json.status === 'success') {
                            items.value = json.data;
                            localStorage.setItem('sakura_tracker_data', JSON.stringify(json.data));
                        }
                    } catch (e) {
                        console.error(e);
                    } finally {
                        loading.value = false;
                    }
                };

                // 3. ç¯©é¸é‚è¼¯ (åŠ å…¥ Search Query)
                const uniqueMembers = computed(() => {
                    const members = items.value.map(i => i.member);
                    return [...new Set(members)].sort();
                });

                const filteredItems = computed(() => {
                    let result = items.value;
                    // å…ˆéæ¿¾æˆå“¡
                    if (currentFilter.value !== 'Total') {
                        result = result.filter(i => i.member === currentFilter.value);
                    }
                    // å†éæ¿¾æœå°‹é—œéµå­—
                    if (searchQuery.value) {
                        const q = searchQuery.value.toLowerCase();
                        result = result.filter(i => i.set_name.toLowerCase().includes(q));
                    }
                    return result;
                });

                // æ–°å¢é …ç›®
                const addNewItem = async () => {
                    if (!newItem.value.member || !newItem.value.set_name) return alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
                    submitting.value = true;

                    const posesArray = newItem.value.poses_input.split(/[,ï¼Œ]/).map(p => ({ n: p.trim(), s: 0 })).filter(p => p.n);
                    const payload = {
                        id: Date.now(),
                        member: newItem.value.member,
                        set_name: newItem.value.set_name,
                        poses_json: posesArray
                    };

                    items.value.unshift(payload);
                    showInputForm.value = false;  // æ–°å¢å¾Œè‡ªå‹•æ”¶èµ·

                    try {
                        await fetch(API_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: 'upsert', data: payload })
                        });
                        newItem.value.set_name = '';
                    } catch (e) {
                        alert('æ–°å¢å¤±æ•—');
                    } finally {
                        submitting.value = false;
                    }
                };

                // åˆªé™¤é …ç›®
                const deleteItem = async (item) => {
                    if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${item.member} ${item.set_name}ã€å—ï¼Ÿ`)) return;
                    items.value = items.value.filter(i => i.id !== item.id);
                    try {
                        await fetch(API_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: 'delete', data: { id: item.id } })
                        });
                    } catch (e) { }
                };

                // Helper Functions (ä¿æŒä¸è®Š)
                const cyclePoseState = (item, poseIndex) => {
                    let currentStatus = item.poses_json[poseIndex].s;
                    item.poses_json[poseIndex].s = (currentStatus + 1) % 4;
                    saveItemDebounced(item);
                };

                const saveItemDebounced = (item) => {
                    item._saving = true;
                    if (debounceTimers[item.id]) clearTimeout(debounceTimers[item.id]);
                    debounceTimers[item.id] = setTimeout(async () => {
                        try {
                            await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'upsert', data: item }) });
                        } finally { item._saving = false; delete debounceTimers[item.id]; }
                    }, 1500);
                };

                const getButtonClass = (status) => {
                    switch (status) {
                        case 1: return 'bg-sakura text-white border-sakura shadow-md';
                        case 2: return 'bg-yellow-400 text-yellow-900 border-yellow-400';
                        case 3: return 'bg-blue-400 text-white border-blue-400';
                        default: return 'bg-gray-50 text-gray-400 border-gray-200';
                    }
                };

                const getStatusLabel = (s) => ['NONE', 'GET', 'TRADE', 'SPARE'][s];
                const isComp = (poses) => poses && poses.length > 0 && poses.every(p => p.s === 1);

                onMounted(() => { fetchData(); });

                // å›å‚³è®Šæ•¸çµ¦ HTML ä½¿ç”¨
                return {
                    items, loading, submitting, allMembers, newItem, currentFilter,
                    uniqueMembers, filteredItems,
                    addNewItem, cyclePoseState, getButtonClass, getStatusLabel, isComp, deleteItem,
                    // æ–°åŠŸèƒ½è®Šæ•¸è¨˜å¾—å›å‚³
                    searchQuery, showInputForm
                };
            }
        }).mount('#app');
    </script>
</body>


</html>

